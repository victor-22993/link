<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Información Médica</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 15px;
    }
    .card {
      width: 100%;
      max-width: 350px;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }
    .header {
      background: linear-gradient(90deg, #6a11cb, #2575fc);
      height: 60px;
    }
    .content {
      padding: 20px;
    }
    .avatar {
      width: 110px;
      height: 110px;
      border-radius: 55px;
      border: 4px solid white;
      margin: -40px auto 15px;
      overflow: hidden;
      background: #f0f0f0;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .avatar svg {
      width: 60%;
      height: 60%;
      fill: #2575fc;
    }
    .field {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }
    .label {
      color: #555;
    }
    .value {
      font-weight: bold;
      color: #333;
      text-align: right;
      max-width: 60%;
      word-break: break-word;
    }
    .contacts {
      margin-top: 20px;
      background: #f9f9f9;
      border-radius: 8px;
      padding: 12px;
    }
    .contacts-title {
      font-weight: bold;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid #eee;
    }
    .contact-item {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      border-bottom: 1px dashed #ddd;
    }
    .contact-item:last-child {
      border-bottom: none;
    }
    /* Estilo para modo depuración */
    .debug {
      margin-top: 10px;
      background: #fff8e1;
      padding: 10px;
      border-radius: 5px;
      font-size: 11px;
      color: #333;
      display: none;
      white-space: pre-wrap;
      word-break: break-all;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="header"></div>
    <div class="content">
      <div class="avatar" id="avatar">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
        </svg>
      </div>
      
      <div>
        <div class="field"><span class="label">Nombre:</span><span id="name" class="value">Cargando...</span></div>
        <div class="field"><span class="label">Nacimiento:</span><span id="birthDate" class="value">Cargando...</span></div>
        <div class="field"><span class="label">Grupo Sanguíneo:</span><span id="bloodType" class="value">Cargando...</span></div>
        <div class="field"><span class="label">Alergias:</span><span id="allergies" class="value">Cargando...</span></div>
      </div>
      
      <div class="contacts">
        <div class="contacts-title">Contactos Familiares</div>
        <div id="contactsList">
          <div class="contact-item"><span>Cargando contactos...</span></div>
        </div>
      </div>
      
      <!-- Información de depuración (oculta) -->
      <div id="debug" class="debug"></div>
    </div>
  </div>

  <script>
    // Configuración
    const DEBUG = false; // Cambia a true para ver información de depuración
    const DEFAULT_VALUES = {
      name: 'No disponible',
      birthDate: 'No disponible',
      bloodType: 'No disponible',
      allergies: 'Ninguna'
    };
    
    // Elementos del DOM
    const nameEl = document.getElementById('name');
    const birthDateEl = document.getElementById('birthDate');
    const bloodTypeEl = document.getElementById('bloodType');
    const allergiesEl = document.getElementById('allergies');
    const contactsListEl = document.getElementById('contactsList');
    const avatarEl = document.getElementById('avatar');
    const debugEl = document.getElementById('debug');
    
    // Función de registro
    function log(message) {
      if (DEBUG) {
        debugEl.style.display = 'block';
        debugEl.innerHTML += message + '\n';
        console.log(message);
      }
    }
    
    // Obtener parámetros de URL
    function getUrlParam(name) {
      try {
        const url = new URL(window.location.href);
        return url.searchParams.get(name);
      } catch (e) {
        log('Error obteniendo parámetros: ' + e);
        return null;
      }
    }
    
    // Actualizar la UI con datos
    function updateUI(data) {
      try {
        // Datos básicos
        nameEl.textContent = data.name || DEFAULT_VALUES.name;
        birthDateEl.textContent = data.birthDate || DEFAULT_VALUES.birthDate;
        bloodTypeEl.textContent = data.bloodType || DEFAULT_VALUES.bloodType;
        allergiesEl.textContent = data.allergies || DEFAULT_VALUES.allergies;
        
        // Contactos
        let contactsHTML = '';
        
        if (Array.isArray(data.contacts) && data.contacts.length > 0) {
          data.contacts.forEach(contact => {
            if (contact && contact.name && contact.phone) {
              contactsHTML += `<div class="contact-item"><span>${contact.name}</span><span>${contact.phone}</span></div>`;
            }
          });
        }
        
        if (contactsHTML) {
          contactsListEl.innerHTML = contactsHTML;
        } else {
          contactsListEl.innerHTML = '<div class="contact-item"><span>No hay contactos registrados</span></div>';
        }
        
        // Imagen (si existe)
        if (data.userImage && data.userImage.length > 0) {
          setTimeout(loadImage, 0, data.userImage);
        }
        
        log('UI actualizada con éxito');
      } catch (e) {
        log('Error actualizando UI: ' + e);
      }
    }
    
    // Cargar imagen
    function loadImage(base64Data) {
      try {
        log('Intentando cargar imagen...');
        const img = new Image();
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        
        // Detectar formato
        let format = 'jpeg';
        if (base64Data.startsWith('iVBOR')) {
          format = 'png';
          log('Formato detectado: PNG');
        } else {
          log('Formato no detectado, usando JPEG por defecto');
        }
        
        // Manejar errores de carga
        img.onerror = function() {
          log('Error cargando imagen, intentando formato alternativo');
          format = (format === 'jpeg') ? 'png' : 'jpeg';
          img.src = `data:image/${format};base64,${base64Data}`;
          
          img.onerror = function() {
            log('Fallo definitivo al cargar imagen');
          };
        };
        
        // Cuando la imagen carga correctamente
        img.onload = function() {
          log('Imagen cargada correctamente');
          avatarEl.innerHTML = '';
          avatarEl.appendChild(img);
        };
        
        // Iniciar carga
        img.src = `data:image/${format};base64,${base64Data}`;
      } catch (e) {
        log('Error procesando imagen: ' + e);
      }
    }
    
    // Función principal
    function init() {
      log('Iniciando...');
      
      try {
        // Obtener datos
        const dataParam = getUrlParam('data');
        const nameParam = getUrlParam('name');
        
        // Caso 1: Solo nombre
        if (!dataParam && nameParam) {
          log('Solo se encontró el parámetro name');
          nameEl.textContent = nameParam;
          birthDateEl.textContent = DEFAULT_VALUES.birthDate;
          bloodTypeEl.textContent = DEFAULT_VALUES.bloodType;
          allergiesEl.textContent = DEFAULT_VALUES.allergies;
          contactsListEl.innerHTML = '<div class="contact-item"><span>No hay contactos registrados</span></div>';
          return;
        }
        
        // Caso 2: Sin datos
        if (!dataParam) {
          log('No se encontraron datos');
          nameEl.textContent = DEFAULT_VALUES.name;
          birthDateEl.textContent = DEFAULT_VALUES.birthDate;
          bloodTypeEl.textContent = DEFAULT_VALUES.bloodType;
          allergiesEl.textContent = DEFAULT_VALUES.allergies;
          contactsListEl.innerHTML = '<div class="contact-item"><span>No hay contactos registrados</span></div>';
          return;
        }
        
        log('Datos encontrados, decodificando...');
        
        // Caso 3: Datos completos - intentamos decodificar JSON
        try {
          const jsonStr = decodeURIComponent(dataParam);
          log(`JSON decodificado (${jsonStr.length} caracteres)`);
          
          const data = JSON.parse(jsonStr);
          log('JSON parseado correctamente');
          
          // Actualizar interfaz con datos obtenidos
          updateUI(data);
        } catch (e) {
          log('Error parseando JSON: ' + e);
          nameEl.textContent = 'Error en datos';
          birthDateEl.textContent = DEFAULT_VALUES.birthDate;
          bloodTypeEl.textContent = DEFAULT_VALUES.bloodType;
          allergiesEl.textContent = DEFAULT_VALUES.allergies;
          contactsListEl.innerHTML = '<div class="contact-item"><span>No hay contactos registrados</span></div>';
        }
        
      } catch (e) {
        log('Error general: ' + e);
        nameEl.textContent = 'Error';
        birthDateEl.textContent = 'Error';
        bloodTypeEl.textContent = 'Error';
        allergiesEl.textContent = 'Error';
      }
    }
    
    // Iniciar inmediatamente
    init();
    
    // Doble clic para mostrar/ocultar debug
    document.addEventListener('dblclick', function() {
      debugEl.style.display = debugEl.style.display === 'none' || debugEl.style.display === '' ? 'block' : 'none';
    });
  </script>
</body>
</html>
